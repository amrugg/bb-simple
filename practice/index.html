<html>
    <head>
        <title>Q Practice</title>
        <meta content="">
        <style>
            .button {
                width: 100%;
                display: block;
                height: 100px;
                font-size: 30px;
                overflow: hidden;
            }
            #timer {
                position: absolute;
                bottom: 0px;
                right: 0px;
                margin: 10px;
            }
            #shew {
                position: absolute;
                bottom: 0px;
                left: 0px;
                margin: 10px;
                width: 100px;
                height: 100px;
                border-radius: 50%;
                opacity: 0;
            }
            .span {
                color: white;
                font-size: 30px;
            }
            progress {
                width: 99.9%;
                box-sizing: border-box;
                padding: 10px;
                margin: 0 auto;
                bottom: 1px;
            }
        </style>
    </head>
    <body style="background-color: #110B31">
        <h1 id="question" style="text-align: center; background-color: D9C800; padding: 20px; border-radius: 10px;">On that night could not the king sleep, and he commanded to bring the book of records of the chronicles; and they were read before the king.</h1>
        <button id="b1" class="button" style="background-color: 3C71F7;">Esther 6:1</button>
        <button id="b2" class="button" style="background-color: C52F21;">Esther 6:1</button>
        <button id="b3" class="button" style="background-color: 409614;">Esther 6:1</button>
        <button id="b4" class="button" style="background-color: D92662;">Esther 6:1</button>
        
        <progress value=0 max=1 id=progress></progress>
        <div id="settings">
            <span class="span">Time:</span> <input type="number" id="timeInput"min="1" max="100" value="5"><br>
            <span class="span">Max Scores:</span> <input id="scoreInput" type="number" min="1" max="100" value="2"><br>
            <span class="span">In a row:</span> <input type="checkbox" id="rowInput">checked><br>
            <span class="span">Reverse:</span> <input type="checkbox" id="reverse"><br>
        </div>
        <div id="timer" style="font-size: 50px; color: F1F1F1">0.5</div>
        <div id="shew"></div>
        <script>
            var progressBar = document.getElementById("progress");
            var base = [["third/three", "šālôš"],
["year", "šānâ"],
["reign/realm", "malḵûṯ"],
["king", "meleḵ"],
["Babylon", "bāḇel"],
["besieged", "ṣûr"],
["hand", "yāḏ"],
["vessels", "kᵊlî"],
["house", "bayiṯ"],
["God", "ĕlōhîm"],
["treasure", "ôṣār"],
["spake", "āmar"],
["master", "raḇ"],
["eunuchs", "sārîs"],
["princes", "partᵊmîm"],
["Children", "yeleḏ"],
["skill, skillful", "śāḵal"],
["knowledge", "daʿaṯ"],
["science, knowledge (Dan 1:17)", "madāʿ"],
["cunning", "yāḏaʿ"],
["wisdom", "ḥāḵmâ"],
["blemish", "mᵊ'ûm"],
["palace", "hêḵāl"],
["teach", "lāmaḏ"],
["learning", "sēp̄er"],
["tongue", "lāšôn"],
["Chaldeans (Hebrew)", "kaśdîmâ"],
["daily", "yôm"],
["provision", "dāḇār"],
["portion of (the king's) meat", "pathbag'"],
["wine", "yayin"],
["nourishing", "gāḏal"],
["stand", "ʿāmaḏ"],
["prince (of the eunuchs)", "śar"],
["heart", "lēḇ"],
["defile", "gā'al"],
["drink, drank", "mištê"],
["request, enquire", "bāqaš"],
["favor", "ḥeseḏ"],
["tender love", "raḥam"],
["fear", "yārē'"],
["lord", "āḏôn"],
["appointed/set", "mānâ"],
["worse liking", "zāʿap̄"],
["prove", "nāsâ"],
["servants", "ʿeḇeḏ"],
["ten", "ʿeśer"],
["pulse", "zērʿōn"],
["eat", "'āḵal"],
["water", "mayim"],
["countenance", "mar'ê"],
["see, look, appear", "rā'â"],
["fatter", "bārî"],
["four", "arbaʿ"],
["visions", "ḥāzôn"],
["dreams", "ḥălôm"],
["communed, spake", "dāḇar"],
["understanding (as noun, Dan 1:20, 2:21)", "bînâ"],
["magicians", "ḥarṭōm"],
["astrologers", "aššāp̄"],
["continued", "hāyâ"],
["Cyrus", "kôreš"]];

            var scores = [];
            var store = localStorage.getItem("store");
            var activeSet;
            if(store) {
                if(confirm("It seems that you left in the middle of a set, do you wish to continue?")) {
                    store = JSON.parse(store)
                    activeSet = store.set;
                    scores = store.scores;
                } else {
                    localStorage.removeItem("store");
                    activeSet = splitJSON(base);
                }
            } else {
                activeSet = splitJSON(base);
            }
            var settingsEl = document.getElementById("settings");
            var timeInput = document.getElementById("timeInput");
            timeInput.addEventListener("input", function(){
                settings.passTime = Number(timeInput.value);
            });
            var scoreInput = document.getElementById("scoreInput");
            scoreInput.addEventListener("input", function(){
                settings.passScore = Number(scoreInput.value);
            });
            var rowInput = document.getElementById("rowInput");
            rowInput.addEventListener("input", function(){
                settings.inARow = Number(rowInput.checked);
            });
            var buttons = [document.getElementById("b1"), document.getElementById("b2"), document.getElementById("b3"), document.getElementById("b4")];
            buttons.forEach(function(button) {
                button.addEventListener("click", function(e) {
                    answerQuestion(e.srcElement.option);
                });
            });
            setTimeout(function(){
                settingsEl.hidden = true;
            }, 10000);
            addEventListener("keypress", function(e) {
                if(e.code === "KeyO") {
                    settingsEl.hidden = !settingsEl.hidden;
                } else if(parseInt(e.key)) {
                    var num = parseInt(e.key)-1;
                    if (num < buttons.length && num > -1) {
                        answerQuestion(buttons[num].option);
                    }
                }
            });
            var colors = ["4EB31B", "EE402E", "FFBF00", "F1F1F1"];
            var mode = "play";
            var shew = document.getElementById("shew");
            var questionDiv = document.getElementById("question");
            var activeQuestion = {};
            var timerEl = document.getElementById("timer");
            timerEl.addEventListener("click", function() {
                if(timerEl.style.color === 'rgb(17, 11, 49)') {
                    timerEl.style.color = "F1F1F1"
                } else {
                    timerEl.style.color = "110B31"
                }
            });
            var clock = Date.now();
            var timeEvent = setInterval(updateClock,100);
            askQuestion();
            var settings = {
                passTime: 5, ///seconds to count as a point
                passScore: 2, ///correct answers before completing question
                inARow: true ///answers have to be correct in a row else it counts as failure
            };
            function askQuestion(skip) {
                var randQ = randInt(0, activeSet.a.length-1);
                if(activeSet.a.length > 2) {
                    while(randQ === skip) {
                        randQ = randInt(0, activeSet.a.length-1);
                    }
                }
                questionDiv.innerHTML = activeSet.a[randQ];
                var BUG = findIndex(activeSet.options, activeSet.b[randQ]);

                var choices = [BUG];
                
                while(choices.length < 4) {
                    var rand = randInt(0, activeSet.options.length-1);
                    if(!choices.includes(rand)) {
                        choices.push(rand);
                    }
                }
                shuffle(choices);
                for(var i = 0; i < choices.length; i++) {
                    if(choices[i] === BUG) {
                        buttons[i].innerHTML = limit(activeSet.b[randQ], innerWidth/7.5);
                        buttons[i].option = randQ;
                    } else {
                        // console.log(activeSet.options, choices, i);
                        buttons[i].innerHTML = limit(activeSet.options[choices[i]], innerWidth/7.5);
                        buttons[i].option = -17;
                    }
                }
                activeQuestion.q = activeSet.a[randQ];
                activeQuestion.a = randQ;
            };
            function limit(str, i) {
                if(str.length > i) {
                    str = str.substring(0, i-3);
                    str += "...";
                }
                return str;
            }
            function answerQuestion(a) {
                if(a === activeQuestion.a) {
                    if(mode === "incorrect") {
                        mode = "play";
                        buttons.forEach(function(e){e.disabled = false;});
                        askQuestion(a);
                        clock = Date.now();
                        timeEvent = setInterval(updateClock, 100);
                    } else {
                        if(Math.round((Date.now() - clock)/100)/10 <= settings.passTime) {
                            if(scores[a]) {
                                scores[a]++;
                            } else {
                                scores[a] = 1;
                            }
                            if(scores[a] >= settings.passScore) {
                                scores.splice(a,1);
                                activeSet.a.splice(a,1);
                                activeSet.b.splice(a,1);
                                shew.style.backgroundColor = colors[3];
                                shew.style.transition = "opacity 0s linear";
                                shew.style.opacity = "1";
                                setTimeout(function() {

                                shew.style.transition = "opacity 0.5s linear";
                                shew.style.opacity = "0";
                                },1);
                            } else {

                            shew.style.backgroundColor = colors[0];
                            shew.style.transition = "opacity 0s linear";
                            shew.style.opacity = "1";
                            setTimeout(function() {

                            shew.style.transition = "opacity 0.5s linear";
                            shew.style.opacity = "0";
                            },1);
                            }
                        } else {

                            shew.style.backgroundColor = colors[2];
                            shew.style.transition = "opacity 0s linear";
                            shew.style.opacity = "1";
                            setTimeout(function() {

                            shew.style.transition = "opacity 0.5s linear";
                            shew.style.opacity = "0";
                            },1);
                        }
                        progressBar.value = 1-(activeSet.a.length/activeSet.options.length);
                        localStorage.setItem("store", JSON.stringify({set: activeSet, scores: scores}));
                        if(activeSet.a.length) {
                            askQuestion(a);
                            clock = Date.now();
                        } else {
                            localStorage.removeItem("store");
                            alert("You won!");
                        }
                    }
                } else {
                    shew.style.backgroundColor = colors[1];
                            shew.style.transition = "opacity 0s linear";
                            shew.style.opacity = "1";
                            setTimeout(function() {

                            shew.style.transition = "opacity 0.5s linear";
                            shew.style.opacity = "0";
                            },1);
                    if(settings.inARow) {
                        scores[activeQuestion.a] = 0;
                        clearInterval(timeEvent);
                        buttons.forEach(function(e) {
                            if(e.option !== activeQuestion.a) {
                                e.disabled = true;
                                mode = "incorrect";
                            }
                        })
                    }
                }
            }
            function split(arr) {
                console.log(arr.length)
                arr = arr.filter(function(e){return e});
                console.log(arr.length)

                var set = {a: [], b: [], options: []};
                for(var i = 0; i < arr.length; i++) {
                    var cur = arr[i].split("|");
                    if(cur.length !== 2) {
                        alert("Something went wrong at index " + i + ", skipping");
                        continue;
                    }
                    if(document.getElementById("reverse").checked) {
                        set.b.push(cur[0]);
                        set.a.push(cur[1]);
                        set.options.push(cur[0]);
                    } else {
                        set.a.push(cur[0]);
                        set.b.push(cur[1]);
                        set.options.push(cur[1]);
                    }
                }
                return set;
            }
            function findIndex(arr, el) {
                for(var i = 0; i < arr.length; i++) {
                    if(arr[i]===el)
                    return i;
                }
                alert("HELP!")
            }
            function updateClock() {
                var num = Math.round((Date.now() - clock)/100)/10;
                if(Math.round(num) === num) {
                    num += ".0";
                }
                timerEl.innerHTML = num;
            }
            function randInt(min, max) {
                if(max === undefined) {
                    max = min
                    min = 1
                }
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            function shuffle(arr, from, to)
            {
                var i,
                    rand,
                    tmp;
                
                if (!arr) {
                    return;
                }
                
                if (typeof from === "undefined") {
                    from = 0;
                }
                
                if (typeof to === "undefined") {
                    to = arr.length - 1;
                }
                
                for (i = from; i < to; i += 1) {
                    rand = Math.floor(Math.random() * (to - from + 1)) + from;
                    if (rand !== i) {
                        tmp = arr[i];
                        arr[i] = arr[rand];
                        arr[rand] = tmp;
                    }
                }
            }
            addEventListener("paste", onPaste);
            function onPaste(e) {
                clock=Date.now();
                text = e.clipboardData.getData("text/plain").trim();
                if(text[0] === "[") {
                    var newSet = JSON.parse(text);
                    activeSet = splitJSON(newSet);
                    scores = [];
                    askQuestion();
                    return;
                }
                text = text.replace(/\t/gi, "|");
                text = text.replace(/\[/gi,"");
                text = text.replace(/\]/gi,"");
        
                text = text.split("\n");
                if(text[0].indexOf("|") > -1) {
                    activeSet = split(text);
                    scores = [];
                    askQuestion();
                } else {
                    alert("Could not parse")
                }
            }
            function splitJSON(arr) {
                var set = {a: [], b: [], options: []};
                for(var i = 0; i < arr.length; i++) {
                    set.a.push(arr[i][0]);
                    set.b.push(arr[i][1]);
                    set.options.push(arr[i][1]);
                }
                return set;
            }
        </script>
  </body>
</html>